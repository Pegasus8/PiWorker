package stats

import (
	"log"
	"path/filepath"
	"time"

	"github.com/Pegasus8/piworker/core/data"
)

// StartLoop is the function used to start the loop used to work with
// the statistics generated by PiWorker and the Raspberry Pi where it's running.
func StartLoop(statsChannel chan Statistic, dataChannel chan data.UserData) {
	log.Println("Preparing to start stats loop...")

	log.Println("Preparing database...")
	db, err := InitDB(filepath.Join(SatisticsPath, DatabaseName))
	if err != nil {
		log.Panicln(err)
	}
	defer db.Close()
	err = CreateTable(db)
	if err != nil {
		log.Panicln(err)
	}
	log.Println("Database ready to work")

	log.Println("Starting stats loop...")
	for range time.Tick(1 * time.Second) {
		userData := <-dataChannel
		statistics, err := GetStatistics(&userData)
		if err != nil {
			log.Panicln(err)
		}
		select {
		case statsChannel <- *statistics:
			// Sending data to channel
		default:
			// No receiver
		}

		StoreRasberryStatistics(db, statistics.RaspberryStats)
	}
}
